@page "/calendar"
@using SwiftOpsToolbox.Models
@using SwiftOpsToolbox.Services
@inject CalendarService CalendarService
@inject HolidayService HolidayService
@rendermode InteractiveServer

<PageTitle>Calendar - Monthly Planner</PageTitle>

<div class="calendar-container">
    <div class="calendar-main-section">
    <div class="calendar-header">
        <h1>üìÖ Monthly Planner</h1>
        <div class="calendar-navigation">
            <button class="icon-text-btn primary" @onclick="PreviousMonth">
                <span class="icon">‚¨ÖÔ∏è</span>
                <span class="text">Previous</span>
            </button>
            <h2>@CurrentDate.ToString("MMMM yyyy")</h2>
            <button class="icon-text-btn primary" @onclick="NextMonth">
                <span class="icon">‚û°Ô∏è</span>
                <span class="text">Next</span>
            </button>
        </div>
        <div class="calendar-actions">
            @if (CalendarService.IsGoogleCalendarConnected)
            {
                <button class="icon-text-btn info" @onclick="SyncWithGoogle" disabled="@IsSyncing">
                    <span class="icon">üîÑ</span>
                    <span class="text">@(IsSyncing ? "Syncing..." : "Sync with Google")</span>
                </button>
                <span class="sync-status">‚úÖ Google Calendar Connected</span>
            }
            else
            {
                <a href="/settings" class="icon-text-btn secondary">
                    <span class="icon">‚öôÔ∏è</span>
                    <span class="text">Connect Google</span>
                </a>
            }
            <button class="icon-text-btn success" @onclick="ShowAddEventModal">
                <span class="icon">‚ûï</span>
                <span class="text">Add Event</span>
            </button>
        </div>
    </div>

    <div class="calendar-grid">
        <div class="calendar-weekdays">
            <div class="weekday">Sunday</div>
            <div class="weekday">Monday</div>
            <div class="weekday">Tuesday</div>
            <div class="weekday">Wednesday</div>
            <div class="weekday">Thursday</div>
            <div class="weekday">Friday</div>
            <div class="weekday">Saturday</div>
        </div>

        <div class="calendar-days">
            @foreach (var day in GetCalendarDays())
            {
                <div class="calendar-day @(day.IsCurrentMonth ? "" : "other-month") @(day.Date.Date == DateTime.Today ? "today" : "")" 
                     @onclick="() => SelectDay(day.Date)">
                    <div class="day-number">@day.Date.Day</div>
                    <div class="day-events">
                        @foreach (var holiday in day.Holidays)
                        {
                            <div class="event-item holiday-item" style="background-color: @holiday.Color" title="@holiday.Name - @holiday.Description">
                                <span class="event-time">üéâ</span>
                                <span class="event-title">@holiday.Name</span>
                            </div>
                        }
                        @foreach (var evt in day.Events.Take(Math.Max(0, 3 - day.Holidays.Count())))
                        {
                            <div class="event-item" style="background-color: @evt.Color" title="@evt.Title - @evt.Description">
                                <span class="event-time">@(evt.IsAllDay ? "All Day" : evt.StartTime.ToString("HH:mm"))</span>
                                <span class="event-title">@evt.Title</span>
                            </div>
                        }
                        @{
                            var totalItems = day.Holidays.Count() + day.Events.Count();
                            var displayedItems = day.Holidays.Count() + Math.Min(day.Events.Count(), 3 - day.Holidays.Count());
                        }
                        @if (totalItems > displayedItems)
                        {
                            <div class="event-more">+@(totalItems - displayedItems) more</div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    @if (ShowEventModal)
    {
        <div class="modal-backdrop" @onclick="CloseModal"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>@(EditingEvent.Id == 0 ? "Add New Event" : "Edit Event")</h3>
                    <button class="icon-text-btn secondary" @onclick="CloseModal" style="min-width: 50px;">
                        <span class="icon">‚úñÔ∏è</span>
                        <span class="text">Close</span>
                    </button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(ValidationError))
                    {
                        <div class="alert alert-danger">@ValidationError</div>
                    }
                    <div class="form-group">
                        <label>Title: <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" @bind="EditingEvent.Title" />
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <textarea class="form-control" @bind="EditingEvent.Description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Start Date & Time:</label>
                        <input type="datetime-local" class="form-control" @bind="EditingEvent.StartTime" />
                    </div>
                    <div class="form-group">
                        <label>End Date & Time:</label>
                        <input type="datetime-local" class="form-control" @bind="EditingEvent.EndTime" />
                    </div>
                    <div class="form-group">
                        <label>Color:</label>
                        <input type="color" class="form-control" @bind="EditingEvent.Color" />
                    </div>
                </div>
                <div class="modal-footer">
                    @if (EditingEvent.Id != 0)
                    {
                        <button class="icon-text-btn danger" @onclick="DeleteEvent">
                            <span class="icon">üóëÔ∏è</span>
                            <span class="text">Delete</span>
                        </button>
                    }
                    <button class="icon-text-btn secondary" @onclick="CloseModal">
                        <span class="icon">‚ùå</span>
                        <span class="text">Cancel</span>
                    </button>
                    <button class="icon-text-btn primary" @onclick="SaveEvent">
                        <span class="icon">üíæ</span>
                        <span class="text">Save</span>
                    </button>
                </div>
            </div>
        </div>
    }
    
    @if (SelectedDay.HasValue)
    {
        <div class="day-details">
            <h3>Events on @SelectedDay.Value.ToString("MMMM d, yyyy")</h3>
            @{
                var dayEvents = CalendarService.GetEventsForDay(SelectedDay.Value).ToList();
                var dayHolidays = HolidayService.GetHolidaysForDay(SelectedDay.Value).ToList();
            }
            @if (dayHolidays.Any())
            {
                <div class="event-list">
                    <h4 style="color: #dc3545; margin-bottom: 10px;">üéâ Holidays</h4>
                    @foreach (var holiday in dayHolidays)
                    {
                        <div class="event-card holiday-card" style="border-left: 4px solid @holiday.Color">
                            <div class="event-card-header">
                                <strong>@holiday.Name</strong>
                                <span class="badge" style="background-color: @GetHolidayTypeBadgeColor(holiday.Type)">
                                    @holiday.Type
                                </span>
                            </div>
                            @if (!string.IsNullOrEmpty(holiday.Description))
                            {
                                <div class="event-card-description">@holiday.Description</div>
                            }
                        </div>
                    }
                </div>
            }
            @if (dayEvents.Any())
            {
                <div class="event-list">
                    <h4 style="margin-bottom: 10px;">üìÖ Events</h4>
                    @foreach (var evt in dayEvents)
                    {
                        <div class="event-card" style="border-left: 4px solid @evt.Color" @onclick="() => EditEvent(evt)">
                            <div class="event-card-header">
                                <strong>@evt.Title</strong>
                                <span class="event-card-time">
                                    @if (evt.IsAllDay)
                                    {
                                        <text>All Day</text>
                                    }
                                    else
                                    {
                                        <text>@evt.StartTime.ToString("HH:mm") - @evt.EndTime.ToString("HH:mm")</text>
                                    }
                                </span>
                            </div>
                            @if (!string.IsNullOrEmpty(evt.Description))
                            {
                                <div class="event-card-description">@evt.Description</div>
                            }
                        </div>
                    }
                </div>
            }
            @if (!dayEvents.Any() && !dayHolidays.Any())
            {
                <p>No events or holidays scheduled for this day.</p>
            }
        </div>
    }
    </div>

    <!-- Monthly Holidays & Events Side Panel -->
    <div class="side-panel">
        <div class="side-panel-header">
            <h3>üìÖ @CurrentDate.ToString("MMMM yyyy")</h3>
            <p class="side-panel-subtitle">Holidays & Events</p>
        </div>
        <div class="side-panel-content">
            @{
                var monthHolidays = HolidayService.GetHolidaysForMonth(CurrentDate.Year, CurrentDate.Month).ToList();
                var monthEvents = CalendarService.GetEventsForMonth(CurrentDate.Year, CurrentDate.Month).ToList();
            }
            
            @if (monthHolidays.Any())
            {
                <div class="panel-section">
                    <h4 class="section-title">üéâ Holidays</h4>
                    <div class="panel-items">
                        @foreach (var holiday in monthHolidays)
                        {
                            <div class="panel-item holiday-panel-item" @onclick="() => SelectDay(holiday.Date)">
                                <div class="panel-item-date">
                                    <div class="date-day">@holiday.Date.Day</div>
                                    <div class="date-weekday">@holiday.Date.ToString("ddd")</div>
                                </div>
                                <div class="panel-item-details">
                                    <div class="panel-item-title" style="color: @holiday.Color">@holiday.Name</div>
                                    <div class="panel-item-type">@holiday.Type Holiday</div>
                                    @if (!string.IsNullOrEmpty(holiday.Description))
                                    {
                                        <div class="panel-item-description">@holiday.Description</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            @if (monthEvents.Any())
            {
                <div class="panel-section">
                    <h4 class="section-title">üìå Events</h4>
                    <div class="panel-items">
                        @foreach (var evt in monthEvents)
                        {
                            <div class="panel-item" @onclick="() => SelectDay(evt.StartTime.Date)">
                                <div class="panel-item-date">
                                    <div class="date-day">@evt.StartTime.Day</div>
                                    <div class="date-weekday">@evt.StartTime.ToString("ddd")</div>
                                </div>
                                <div class="panel-item-details">
                                    <div class="panel-item-title" style="color: @evt.Color">@evt.Title</div>
                                    <div class="panel-item-time">
                                        @if (evt.IsAllDay)
                                        {
                                            <text>All Day</text>
                                        }
                                        else
                                        {
                                            <text>@evt.StartTime.ToString("HH:mm") - @evt.EndTime.ToString("HH:mm")</text>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(evt.Description))
                                    {
                                        <div class="panel-item-description">@evt.Description</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            @if (!monthHolidays.Any() && !monthEvents.Any())
            {
                <div class="panel-empty">
                    <p>No holidays or events this month.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private DateTime? SelectedDay = null;
    private bool ShowEventModal = false;
    private CalendarEvent EditingEvent = new();
    private string ValidationError = string.Empty;
    private bool IsSyncing = false;

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public List<CalendarEvent> Events { get; set; } = new();
        public List<Holiday> Holidays { get; set; } = new();
    }
    
    protected override async Task OnInitializedAsync()
    {
        // Auto-sync on load if Google Calendar is connected
        await SyncWithGoogle();
    }
    
    private async Task SyncWithGoogle()
    {
        if (!CalendarService.IsGoogleCalendarConnected || IsSyncing)
        {
            return;
        }
        
        IsSyncing = true;
        StateHasChanged();
        
        try
        {
            await CalendarService.SyncWithGoogleCalendarAsync(CurrentDate.Year, CurrentDate.Month);
        }
        finally
        {
            IsSyncing = false;
            StateHasChanged();
        }
    }

    private IEnumerable<CalendarDay> GetCalendarDays()
    {
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        
        // Start from the Sunday before or on the first day of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        // End on the Saturday after or on the last day of the month
        var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);
        
        // Batch load all events for the visible date range
        var allEventsInRange = CalendarService.GetEventsForMonth(CurrentDate.Year, CurrentDate.Month).ToList();
        
        // Get holidays for the current month
        var allHolidaysInRange = HolidayService.GetHolidaysForMonth(CurrentDate.Year, CurrentDate.Month).ToList();
        
        var days = new List<CalendarDay>();
        var currentDate = startDate;
        
        while (currentDate <= endDate)
        {
            var isCurrentMonth = currentDate.Month == CurrentDate.Month;
            var eventsForDay = allEventsInRange.Where(e => e.StartTime.Date == currentDate.Date).ToList();
            var holidaysForDay = allHolidaysInRange.Where(h => h.Date.Date == currentDate.Date).ToList();
            
            days.Add(new CalendarDay
            {
                Date = currentDate,
                IsCurrentMonth = isCurrentMonth,
                Events = eventsForDay,
                Holidays = holidaysForDay
            });
            
            currentDate = currentDate.AddDays(1);
        }
        
        return days;
    }

    private async Task PreviousMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        SelectedDay = null;
        await SyncWithGoogle();
    }

    private async Task NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        SelectedDay = null;
        await SyncWithGoogle();
    }

    private void SelectDay(DateTime date)
    {
        SelectedDay = date;
    }

    private void ShowAddEventModal()
    {
        EditingEvent = new CalendarEvent
        {
            StartTime = SelectedDay ?? DateTime.Today,
            EndTime = (SelectedDay ?? DateTime.Today).AddHours(1),
            Color = "#3788d8"
        };
        ShowEventModal = true;
    }

    private void EditEvent(CalendarEvent evt)
    {
        EditingEvent = new CalendarEvent
        {
            Id = evt.Id,
            Title = evt.Title,
            Description = evt.Description,
            StartTime = evt.StartTime,
            EndTime = evt.EndTime,
            Color = evt.Color,
            GoogleEventId = evt.GoogleEventId
        };
        ShowEventModal = true;
    }

    private void CloseModal()
    {
        ShowEventModal = false;
        EditingEvent = new();
        ValidationError = string.Empty;
    }

    private async Task SaveEvent()
    {
        if (string.IsNullOrWhiteSpace(EditingEvent.Title))
        {
            ValidationError = "Title is required.";
            return;
        }

        if (EditingEvent.EndTime < EditingEvent.StartTime)
        {
            ValidationError = "End time must be after start time.";
            return;
        }

        ValidationError = string.Empty;

        if (EditingEvent.Id == 0)
        {
            await CalendarService.AddEventAsync(EditingEvent);
        }
        else
        {
            await CalendarService.UpdateEventAsync(EditingEvent);
        }
        
        CloseModal();
    }

    private async Task DeleteEvent()
    {
        if (EditingEvent.Id != 0)
        {
            await CalendarService.DeleteEventAsync(EditingEvent.Id);
            CloseModal();
            SelectedDay = null;
        }
    }

    private string GetHolidayTypeBadgeColor(HolidayType type)
    {
        return type switch
        {
            HolidayType.Federal => "#0d6efd",
            HolidayType.Religious => "#6f42c1",
            HolidayType.Cultural => "#fd7e14",
            _ => "#6c757d"
        };
    }
}
